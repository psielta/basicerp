@using System.Linq
@using EntityFrameworkProject.Models
@model WebApplicationBasic.Models.ViewModels.StockDashboardViewModel

@{
    ViewBag.Title = "Estoque";
}

@functions {
    string GetMovementTypeDisplay(StockMovementType type)
    {
        switch (type)
        {
            case StockMovementType.StockReceived:
                return "Entrada";
            case StockMovementType.StockReserved:
                return "Reservado";
            case StockMovementType.StockReleased:
                return "Liberado";
            case StockMovementType.StockShipped:
                return "Saída";
            case StockMovementType.StockAdjusted:
                return "Ajuste";
            case StockMovementType.StockTransferredOut:
                return "Transf. Saída";
            case StockMovementType.StockTransferredIn:
                return "Transf. Entrada";
            default:
                return type.ToString();
        }
    }

    string GetMovementTypeBadgeClass(StockMovementType type)
    {
        switch (type)
        {
            case StockMovementType.StockReceived:
            case StockMovementType.StockTransferredIn:
                return "bg-success";
            case StockMovementType.StockReserved:
                return "bg-warning text-dark";
            case StockMovementType.StockReleased:
                return "bg-info";
            case StockMovementType.StockShipped:
            case StockMovementType.StockTransferredOut:
                return "bg-danger";
            case StockMovementType.StockAdjusted:
                return "bg-secondary";
            default:
                return "bg-secondary";
        }
    }
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Visao geral do estoque</h2>
    <div class="btn-group" role="group">
        @Html.ActionLink("Entrada", "Receive", null, new { @class = "btn btn-primary" })
        @Html.ActionLink("Ajuste", "Adjust", null, new { @class = "btn btn-outline-secondary" })
        @Html.ActionLink("Transferir", "Transfer", null, new { @class = "btn btn-outline-secondary" })
        @Html.ActionLink("Reservar", "Reserve", null, new { @class = "btn btn-outline-secondary" })
        @Html.ActionLink("Baixa", "Ship", null, new { @class = "btn btn-outline-danger" })
        @Html.ActionLink("Locais", "Locations", null, new { @class = "btn btn-outline-dark" })
    </div>
</div>

@using (Html.BeginForm("Index", "Stock", FormMethod.Get, new { @class = "row g-2 mb-3" }))
{
    <div class="col-md-4">
        <input type="text" name="search" value="@Model.Search" class="form-control" placeholder="Buscar por SKU ou nome" />
    </div>
    <div class="col-md-3">
        @Html.DropDownListFor(m => m.LocationId,
            new SelectList(Model.Locations, "Id", "Display", Model.LocationId),
            "Todos os locais",
            new { @class = "form-control select2-location" })
    </div>
    <div class="col-md-2">
        <button type="submit" class="btn btn-primary">Filtrar</button>
    </div>
}

<table class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>SKU</th>
            <th>Produto / Variante</th>
            <th>Local</th>
            <th class="text-end">Fisico</th>
            <th class="text-end">Reservado</th>
            <th class="text-end">Disponivel</th>
            <th>Ultima movimentacao</th>
        </tr>
    </thead>
    <tbody>
        @if (Model.Balances == null || !Model.Balances.Any())
        {
            <tr>
                <td colspan="7" class="text-center">Nenhum registro de estoque encontrado.</td>
            </tr>
        }
        else
        {
            foreach (var item in Model.Balances)
            {
                <tr>
                    <td>@item.Sku</td>
                    <td>
                        <div class="fw-bold">@item.ProductName</div>
                        <small class="text-muted">@item.VariantName</small>
                    </td>
                    <td>@item.LocationName @if(item.IsDefaultLocation){<span class="badge bg-info">Padrao</span>}</td>
                    <td class="text-end">@item.OnHand</td>
                    <td class="text-end">@item.Reserved</td>
                    <td class="text-end">@item.Available</td>
                    <td>@item.LastMovementAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                </tr>
            }
        }
    </tbody>
</table>

<h4 class="mt-4">Reservas ativas</h4>
<table class="table table-sm table-bordered">
    <thead>
        <tr>
            <th>SKU</th>
            <th>Produto</th>
            <th>Local</th>
            <th class="text-end">Quantidade</th>
            <th>Reservado em</th>
            <th>Validade</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @if (Model.ActiveReservations == null || !Model.ActiveReservations.Any())
        {
            <tr><td colspan="7" class="text-center">Nenhuma reserva ativa.</td></tr>
        }
        else
        {
            foreach (var r in Model.ActiveReservations)
            {
                <tr>
                    <td>@r.Sku</td>
                    <td>@r.ProductName<br /><small class="text-muted">@r.VariantName</small></td>
                    <td>@r.LocationName</td>
                    <td class="text-end">@r.Quantity</td>
                    <td>@r.ReservedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                    <td>
                        @if (r.ExpiresAt.HasValue)
                        {
                            var expiresAt = r.ExpiresAt.Value;
                            var now = DateTime.UtcNow;
                            var hoursUntilExpiry = (expiresAt - now).TotalHours;

                            @expiresAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")

                            if (expiresAt < now)
                            {
                                <span class="badge bg-danger ms-1">Vencida</span>
                            }
                            else if (hoursUntilExpiry <= 24)
                            {
                                <span class="badge bg-warning text-dark ms-1">Vence em breve</span>
                            }
                        }
                        else
                        {
                            <text>-</text>
                        }
                    </td>
                    <td class="text-end">
                        @using (Html.BeginForm("ReleaseReservation", "Stock", FormMethod.Post, new { onsubmit = "return confirm('Liberar esta reserva?');" }))
                        {
                            @Html.AntiForgeryToken()
                            @Html.Hidden("id", r.Id)
                            <button class="btn btn-sm btn-outline-secondary" type="submit">Liberar</button>
                        }
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

<h4 class="mt-4">Ultimas movimentacoes</h4>
<table class="table table-sm table-hover">
    <thead>
        <tr>
            <th>Quando</th>
            <th>SKU</th>
            <th>Local</th>
            <th class="text-end">Fisico</th>
            <th class="text-end">Reservado</th>
            <th>Tipo</th>
            <th>Motivo</th>
        </tr>
    </thead>
    <tbody>
        @if (Model.RecentLedger == null || !Model.RecentLedger.Any())
        {
            <tr><td colspan="7" class="text-center">Nenhuma movimentacao registrada.</td></tr>
        }
        else
        {
            foreach (var l in Model.RecentLedger)
            {
                <tr>
                    <td>@l.OccurredAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                    <td>@l.Sku</td>
                    <td>@l.LocationName</td>
                    <td class="text-end">@l.DeltaOnHand</td>
                    <td class="text-end">@l.DeltaReserved</td>
                    <td><span class="badge @GetMovementTypeBadgeClass(l.MovementType)">@GetMovementTypeDisplay(l.MovementType)</span></td>
                    <td>@l.Reason</td>
                </tr>
            }
        }
    </tbody>
</table>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Inicializa Select2 para locais (filtro)
            $('.select2-location').select2({
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: 'Todos os locais',
                allowClear: true
            });
        });
    </script>
}
