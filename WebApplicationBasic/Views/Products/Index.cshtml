@model IEnumerable<WebApplicationBasic.Models.ViewModels.ProductListItemViewModel>

@{
    ViewBag.Title = "Produtos";
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<div class="row mb-3">
    <div class="col-md-6">
        @using (Html.BeginForm("Index", "Products", FormMethod.Get))
        {
            <div class="input-group">
                @Html.TextBox("search", ViewBag.Search as string, new { @class = "form-control", placeholder = "Buscar por nome, slug, marca ou SKU..." })
                <button class="btn btn-outline-secondary" type="submit">
                    <i class="bi bi-search"></i> Buscar
                </button>
            </div>
        }
    </div>
    <div class="col-md-6 text-end">
        @Html.ActionLink("Novo Produto", "SelectType", null, new { @class = "btn btn-primary" })
    </div>
</div>

<table class="table table-striped table-bordered table-hover">
    <thead>
        <tr>
            <th>Nome</th>
            <th>Tipo</th>
            <th>Variantes</th>
            <th>SKU Principal</th>
            <th>Marca</th>
            <th>Categorias</th>
            <th>Status</th>
            <th>Criado em</th>
            <th style="width: 200px;">Ações</th>
        </tr>
    </thead>
    <tbody>
        @if (!Model.Any())
        {
            <tr>
                <td colspan="9" class="text-center">
                    <p style="padding: 20px;">Nenhum produto cadastrado.</p>
                    @Html.ActionLink("Cadastrar primeiro produto", "SelectType", null, new { @class = "btn btn-primary" })
                </td>
            </tr>
        }
        else
        {
            foreach (var item in Model)
            {
                <tr>
                    <td>
                        <strong>@item.Name</strong>
                        @if (!string.IsNullOrEmpty(item.Slug))
                        {
                            <br />
                            <small class="text-muted">@item.Slug</small>
                        }
                        <div style="margin-top: 5px;">
                            @if (item.IsService)
                            {
                                <span class="badge bg-info" title="É Serviço">
                                    <i class="bi bi-wrench"></i> Serviço
                                </span>
                            }
                            @if (item.IsRental)
                            {
                                <span class="badge bg-warning text-dark" title="É Aluguel">
                                    <i class="bi bi-clock"></i> Aluguel
                                </span>
                            }
                            @if (item.HasDelivery)
                            {
                                <span class="badge bg-success" title="Tem Entrega">
                                    <i class="bi bi-truck"></i> Entrega
                                </span>
                            }
                        </div>
                    </td>
                    <td>
                        @if (item.ProductType == WebApplicationBasic.Models.ViewModels.ProductType.Simple)
                        {
                            <span class="badge">Simples</span>
                        }
                        else
                        {
                            <span class="badge" style="background-color: #5bc0de;">Variações</span>
                        }
                    </td>
                    <td>
                        @if (item.VariantCount > 1)
                        {
                            <div>
                                <strong>@item.VariantCount</strong> total<br />
                                <span class="text-success">@item.ActiveVariantCount ativas</span>
                            </div>
                        }
                        else
                        {
                            <span class="text-muted">1 única</span>
                        }
                    </td>
                    <td>
                        @if (!string.IsNullOrEmpty(item.Sku))
                        {
                            <code>@item.Sku</code>
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>
                    <td>
                        @if (!string.IsNullOrEmpty(item.Brand))
                        {
                            @item.Brand
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>
                    <td>
                        @if (item.Categories != null && item.Categories.Any())
                        {
                            foreach (var cat in item.Categories.Take(2))
                            {
                                <span class="badge bg-secondary">@cat</span>
                            }
                            if (item.Categories.Count > 2)
                            {
                                <span class="text-muted">+@(item.Categories.Count - 2)</span>
                            }
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>
                    <td>
                        @if (item.IsActive)
                        {
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle"></i> Ativo
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">
                                <i class="bi bi-x-circle"></i> Inativo
                            </span>
                        }
                    </td>
                    <td>
                        @item.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy")
                        <br />
                        <small class="text-muted">@item.CreatedAt.ToLocalTime().ToString("HH:mm")</small>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            @Html.ActionLink("Editar", "Edit", new { id = item.Id }, new { @class = "btn btn-outline-secondary", title = "Editar produto" })
                            @if (item.VariantCount > 1)
                            {
                                @Html.ActionLink("Variantes", "ManageVariants", new { id = item.Id }, new { @class = "btn btn-outline-info", title = "Gerenciar variantes" })
                            }
                            @Html.ActionLink("Excluir", "Delete", new { id = item.Id }, new { @class = "btn btn-outline-danger", title = "Excluir produto", onclick = "return confirm('Deseja realmente excluir este produto e todas as suas variantes?');" })
                        </div>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

<style>
    .badge {
        margin-right: 3px;
    }
</style>
