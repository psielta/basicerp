@model WebApplicationBasic.Models.ViewModels.ChangePasswordViewModel

@{
    ViewBag.Title = "Alterar Senha";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid px-4">
    <h1 class="mt-4">Alterar Senha</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Home</a></li>
        <li class="breadcrumb-item"><a href="@Url.Action("Profile", "Account")">Meu Perfil</a></li>
        <li class="breadcrumb-item active">Alterar Senha</li>
    </ol>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Defina uma Nova Senha</h5>
                </div>
                <div class="card-body">
                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div class="alert alert-danger">
                            @Html.ValidationSummary(false, "", new { @class = "mb-0" })
                        </div>
                    }

                    @using (Html.BeginForm("ChangePassword", "Account", FormMethod.Post, new { @class = "needs-validation" }))
                    {
                        @Html.AntiForgeryToken()

                        <div class="mb-3">
                            <label for="CurrentPassword" class="form-label">Senha Atual</label>
                            <div class="input-group">
                                @Html.PasswordFor(m => m.CurrentPassword, new { @class = "form-control", placeholder = "Digite sua senha atual", required = "required", id = "currentPassword" })
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('currentPassword', 'toggleIcon1')">
                                    <i class="bi bi-eye" id="toggleIcon1"></i>
                                </button>
                            </div>
                            @Html.ValidationMessageFor(m => m.CurrentPassword, "", new { @class = "text-danger small mt-1" })
                        </div>

                        <hr class="my-4">

                        <div class="mb-3">
                            <label for="NewPassword" class="form-label">Nova Senha</label>
                            <div class="input-group">
                                @Html.PasswordFor(m => m.NewPassword, new { @class = "form-control", placeholder = "Digite sua nova senha", required = "required", id = "newPassword" })
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('newPassword', 'toggleIcon2')">
                                    <i class="bi bi-eye" id="toggleIcon2"></i>
                                </button>
                            </div>
                            @Html.ValidationMessageFor(m => m.NewPassword, "", new { @class = "text-danger small mt-1" })
                            <div class="password-strength mt-2">
                                <div class="progress" style="height: 5px;">
                                    <div id="password-strength-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small id="password-strength-text" class="text-muted"></small>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="ConfirmPassword" class="form-label">Confirmar Nova Senha</label>
                            <div class="input-group">
                                @Html.PasswordFor(m => m.ConfirmPassword, new { @class = "form-control", placeholder = "Confirme sua nova senha", required = "required", id = "confirmPassword" })
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirmPassword', 'toggleIcon3')">
                                    <i class="bi bi-eye" id="toggleIcon3"></i>
                                </button>
                            </div>
                            @Html.ValidationMessageFor(m => m.ConfirmPassword, "", new { @class = "text-danger small mt-1" })
                        </div>

                        <div class="d-grid gap-2 d-md-block">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Alterar Senha
                            </button>
                            <a href="@Url.Action("Profile", "Account")" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0"><i class="bi bi-lightbulb"></i> Dicas de Segurança</h5>
                </div>
                <div class="card-body">
                    <h6>Crie uma senha forte:</h6>
                    <ul class="small">
                        <li>Use pelo menos 8 caracteres</li>
                        <li>Inclua letras maiúsculas e minúsculas</li>
                        <li>Adicione números (0-9)</li>
                        <li>Use caracteres especiais (!&#64;&#35;$%)</li>
                        <li>Evite informações pessoais</li>
                        <li>Não use senhas óbvias (123456, senha, etc.)</li>
                    </ul>

                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Importante:</strong> Após alterar sua senha, você receberá um email de confirmação.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function togglePassword(fieldId, iconId) {
        var passwordInput = $('#' + fieldId);
        var toggleIcon = $('#' + iconId);

        if (passwordInput.attr('type') === 'password') {
            passwordInput.attr('type', 'text');
            toggleIcon.removeClass('bi-eye').addClass('bi-eye-slash');
        } else {
            passwordInput.attr('type', 'password');
            toggleIcon.removeClass('bi-eye-slash').addClass('bi-eye');
        }
    }

    function checkPasswordStrength(password) {
        var strength = 0;
        var strengthBar = $('#password-strength-bar');
        var strengthText = $('#password-strength-text');

        if (password.length >= 8) strength++;
        if (password.match(/[a-z]/)) strength++;
        if (password.match(/[A-Z]/)) strength++;
        if (password.match(/[0-9]/)) strength++;
        if (password.match(/[^a-zA-Z0-9]/)) strength++;

        var percentage = (strength / 5) * 100;
        strengthBar.css('width', percentage + '%');

        if (strength <= 2) {
            strengthBar.removeClass('bg-warning bg-success').addClass('bg-danger');
            strengthText.text('Senha fraca').removeClass('text-warning text-success').addClass('text-danger');
        } else if (strength <= 3) {
            strengthBar.removeClass('bg-danger bg-success').addClass('bg-warning');
            strengthText.text('Senha média').removeClass('text-danger text-success').addClass('text-warning');
        } else {
            strengthBar.removeClass('bg-danger bg-warning').addClass('bg-success');
            strengthText.text('Senha forte').removeClass('text-danger text-warning').addClass('text-success');
        }

        if (password.length === 0) {
            strengthText.text('');
        }
    }

    $(document).ready(function () {
        $('#newPassword').on('input', function () {
            checkPasswordStrength($(this).val());

            // Check if passwords match
            var confirmPassword = $('#confirmPassword').val();
            if (confirmPassword) {
                checkPasswordsMatch();
            }
        });

        $('#confirmPassword').on('input', function () {
            checkPasswordsMatch();
        });

        function checkPasswordsMatch() {
            var newPassword = $('#newPassword').val();
            var confirmPassword = $('#confirmPassword').val();

            if (confirmPassword && newPassword !== confirmPassword) {
                $('#confirmPassword').addClass('is-invalid');
                if (!$('#confirm-error').length) {
                    $('#confirmPassword').parent().after('<div id="confirm-error" class="text-danger small mt-1">As senhas não coincidem.</div>');
                }
            } else if (confirmPassword) {
                $('#confirmPassword').removeClass('is-invalid').addClass('is-valid');
                $('#confirm-error').remove();
            }
        }
    });
</script>
}